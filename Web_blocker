import tkinter as tk
from tkinter import messagebox, simpledialog
import os
import sys
import ctypes

class WebBlocker:
    def __init__(self, root):
        self.root = root
        self.root.title("Web Blocker")
        self.root.geometry("400x400")

        self.hosts_path = r"C:\Windows\System32\drivers\etc\hosts"
        self.redirect_ip = "127.0.0.1"
        self.blocked_websites = self.load_blocked_websites()

        #GUI Elements
        self.label = tk.label(root, text="Enter website to block (e.g. www.example.com):")
        self.label.pack(pady=10)

        self.entry = tk.Entry(root, width=50)
        self.entry.pack(pady=5)
 
 
        self.add_button = tk.Button(root, text="Add to Block List", command=self.add_site)
        self.add_button.pack(pady=5)

        self.listbox = tk.Listbox(root, width=50, height=10)
        self.listbox.pack(pady=10)
        self.update_listbox()

        self.block_button = tk.Button(root, text="Block Selected Sites", command=self.block_websites)
        self.block_button.pack(side=tk.LEFT, padx=10)

        self.unblock_button = tk.Button(root, text="Unblock Selected Sites", command=self.unblock_websites)
        self.unblock_button.pack(side=tk.RIGHT, padx=10)

        self.unblock_all_button = tk.Button(root, text="Unblock All", command=self.unblock_all)
        self.unblock_all_button.pack(pady=10)

def load_blocked_websites(self):
    blocked =[]
    try:
        with open(self.hosts_path, 'r') as file:
            for line in file:
                if line.strip().startswith(self.redirect_ip):
                    parts = line.strip().split()
                    if len(parts) >= 2:
                        blocked.append(parts[1])
    except FileNotFoundError:
        messagebox.showerror("Error", "Hosts file not found. Run as administrator.")
    except PermissionError:
        messagebox.showerror("Error", "Permission denied. Run as administrator.")
    return blocked

def save_hosts(self, lines):
    try:
        with open(self.hosts_paths, 'w') as file:
            file.writelines(lines)
        messagebox.showinfo("Success", "Hosts file updated successfully.")
    except PermissionError:
        messagebox.showerror("Error", "Permission denied. Run as administrator.")

def add_site(self):
    site = self.entry.get().strip()
    if not site:
        messagebox.showwarning("Warning", "Enter a validwebsite.")
        return
    
    #Clean the site: remove protocol
    if site.startswith("http://"):
        site = site[7:]
    elif site.startswith("https://"):
        site = site[8:]

    #REmove trailing slashes
    site = site.rstrip('/')

    sites_to_add =[]
    if site not in self.blocked_websites:
        sites_to_add.append(site)
    if not site.startswith("www.") and ("www." + site) not in self.blocked_websites:
        sites_to_add.append("www." + site)
    elif site.startswith("www.") and site[4:] not in self.blocked_websites:
        sites_to_add.append(site[4:])

    for s in sites_to_add:
        if s not in self.blocked_websites:
            self.blocked_websites.append(s)

    self.update_listbox()
    self.entry.delete(0, tk.END)

def update_listbox(self):
    self.listbox.delete(0, tk.END)
    for site in self.blocked_websites:
        self.listbox.insert(tk.END, site)

def block_websites(self):
    selected = [self.listbox.get(i) for i in self.listbox.curselection()]
    if not selected:
        messagebox.showwarning("Warning", "Select site to block.")
        return
    
    try:
        with open(self.hosts_path, 'r') as file:
            lines - file.readlines()
    except:
        lines = []

    for site in selected:
        entry = f"{self.redirect_ip} {site}\n"
        if entry not in lines:
            lines.append(entry)
    
    self.save_hosts(lines)
    self.blocked_websites = self.load_blocked_websites() # Refresh 

def unblock_websites(self):
    selected = [self.listbox.get(i) for i in self.listbox.curselection()]
    if not selected:
        messagebox.showwarning("Warning", "Select site to unblock.")
        return
    
    try:
        with open(self.hosts_path, 'r') as file:
            lines = file.readlines()
    except:
        lines = []

    new_lines = []
    for line in lines:
        if not any(site in line for site in selected):
            new_lines.append(line)

    self.save_hosts(new_lines)
    for site in selected:
        if site in self.blocked_websites:
            self.blocked_websites.remove(site)
    self.update_listbox() 

def unblock_all(self):
    try:
        with open(self.hosts_path, 'r') as file:
            lines = file.readlines()
    except:
        lines = []

    new_lines = [line for line in lines if not line.strip().startswith(self.redirect_ip)]
    self.save_hosts(new_lines)
    self.blocked_websites.clear()
    self.update_listbox()

def is_admin():
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False
    
if __name__ == "__main__":
    if not is_admin():
        # Re-run the program with admin rights
        ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, __file__, None, 1)
        sys.exit()

    if os.name != 'nt':
        print("This program is only compatible with Windows.")
        sys.exit(1)


    


       

        



















